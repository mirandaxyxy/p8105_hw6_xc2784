---
title: "p8105_hw6_xc2784"
output: github_document
date: "2025-12-03"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,message = FALSE,
  warning = FALSE)
library(tidyverse)
library(broom)
library(patchwork)
library(modelr)

```

### Problem 1

```{r}
raw = read_csv("https://raw.githubusercontent.com/washingtonpost/data-homicides/master/homicide-data.csv")
```

```{r}
homicides <- raw %>%
  mutate(
    city_state = str_c(city, ", ", state),
    solved = as.numeric(disposition == "Closed by arrest"),
    victim_age = as.numeric(victim_age),
    victim_sex  = fct_relevel(victim_sex, "Female"),
    victim_race = fct_relevel(victim_race, "White")) %>% 
  filter(
    !(city == "Dallas" & state == "TX"),
    !(city == "Phoenix" & state == "AZ"),
    !(city == "Kansas City" & state == "MO"),
    !(city == "Tulsa" & state == "AL"),
    (victim_race %in% c("White", "Black")) 
  ) %>% 
    drop_na(
    solved,
    victim_age,
    victim_sex,
    victim_race
  )
```

```{r}
baltimore <- homicides %>%
  filter(city_state == "Baltimore, MD")

baltimore_lr <- glm(
  solved ~ victim_age + victim_sex + victim_race,
  data = baltimore,
  family = binomial
)

baltimore_or <- tidy(baltimore_lr, conf.int = TRUE, exponentiate = TRUE) %>%
 mutate(OR = estimate)%>%
  select(term, OR, conf.low, conf.high)

baltimore_or
```

In Baltimore, male victimsâ€™ homicide cases are 57% less likely to be resolved than those of female victims (adjusted OR = 0.43; 95% CI: 0.32â€“0.58), controlling for age and race.

```{r}
library(purrr)

city_or <- homicides %>%
  group_by(city_state) %>%
  nest() %>%
  mutate(
    model = map(data, ~ glm(
      solved ~ victim_age + victim_sex + victim_race,
      data = .x, family = binomial
    )),
    results = map(model, ~ tidy(.x, conf.int = TRUE, exponentiate = TRUE))
  ) %>%
  unnest(results) %>%
  filter(term == "victim_sexMale")  %>% 
  mutate(OR = estimate)%>%
  select(city_state, OR, conf.low, conf.high)
  

city_or

```

```{r, fig.width = 6, fig.height = 8}
library(ggplot2)

city_ordered <- city_or %>%
  ungroup() %>% 
  arrange(OR) %>% 
  mutate(city_state = factor(city_state,levels = city_state))


city_plot <- ggplot(city_ordered, aes(x = OR, y = city_state)) +
  geom_point() +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high)) +
  geom_vline(xintercept = 1, linetype = "dashed") +
    labs(
      x = "Adjusted OR (Male vs Female Victims)",
      y = "City, State",
      title = "Adjusted Odds Ratios for Resolved Homicides by City"
    ) +
  theme_minimal()

city_plot
```

Most cities have ORs below 1, suggesting that homicides involving male victims tend to be solved at lower rates than those involving female victims once age and race are accounted for. A few cities, such as Albuquerque, Stockton, and Fresno, show ORs above 1, indicating the opposite pattern, but these are exceptions.
However, most cities have ORs near 1, and their confidence intervals cross 1, suggesting there is little evidence of a statistically difference in resolved rates between male and female victims after adjusting for age and race.


### Problem 2

```{r}
library(p8105.datasets)
data("weather_df")

weather <-
  weather_df %>% 
  filter(name == "CentralPark_NY") %>% 
  drop_na(tmax, tmin, prcp)

reg = lm(tmax ~ tmin + prcp, data = weather)
reg %>% glance() %>% select(r.squared)
reg %>% tidy()
```
```{r}

set.seed(1)
n_boot <- 5000

boot_samples <-
  weather %>%
  modelr::bootstrap(n = n_boot, id = "strap_id")

boot_results <-
  boot_samples %>%
  mutate(
    fit  = map(strap, ~ lm(tmax ~ tmin + prcp, data = .x)),
    gl   = map(fit, glance),
    coef = map(fit, tidy)
  ) %>%
  mutate(
    r_sq = map_dbl(gl, "r.squared"),
    beta_ratio = map_dbl(
      coef,
      ~ {
        tmp <- .x %>% select(term, estimate)
        
        b_tmin <- tmp %>%
          filter(term == "tmin") %>%
          pull(estimate)
        
        b_prcp <- tmp %>%
          filter(term == "prcp") %>%
          pull(estimate)
        
        b_tmin / b_prcp
      }
    )
  ) %>%
  select(strap_id, r_sq, beta_ratio)

boot_results

```

```{r, fig.width = 10, fig.height = 6}
p1 = boot_results %>%
  ggplot(aes(x = r_sq)) +
  geom_histogram() +
  theme_minimal() +
  labs(x = "R-squared", title = "Bootstrap distribution of R-squared")

p2 = boot_results %>%
  ggplot(aes(x = beta_ratio)) +
  geom_histogram() +
  theme_minimal() +
  labs(x = "Î²1 / Î²2",
       title = "Bootstrap distribution of beta ratio")

p1+p2

boot_results %>%
  summarize(
    r2_025  = quantile(r_sq, 0.025),
    r2_975  = quantile(r_sq, 0.975),
    br_025  = quantile(beta_ratio, 0.025),
    br_974  = quantile(beta_ratio, 0.975)
  )

```
From the bootstrap results:
r2: 95% CI: [0.89, 0.93]
ð›½1/ð›½2: 95% CI: [â€“5616.45, 4568.92]

The bootstrap distribution of r2 is more concentrated and normally distributed, with most values falling around 0.91â€“0.93. This suggests that the fitted model gives similar r2 values across bootstrap samples.

The bootstrap distribution of the beta ratio ð›½1/ð›½2 is much more spread out, with values covering a very wide range and a tall spike near zero. This indicates that the ratio varies a lot from sample to sample, and its values can become quite large in magnitude. This happens because the coefficient for precipitation is close to zero and flips sign across samples.

### problem 3
```{r}
birthweight = 
  read_csv("./birthweight.csv") %>% 
  janitor::clean_names() %>% 
  mutate(
    babysex = factor(
      babysex,
      levels = c(1, 2),
      labels = c("male", "female")
    ),
    frace = factor(
      frace,
      levels = c(1, 2, 3, 4, 8, 9),
      labels = c("White", "Black", "Asian", "Puerto Rican", "Other", "Unknown")
    ),
    mrace = factor(
      mrace,
      levels = c(1, 2, 3, 4, 8),
      labels = c("White", "Black", "Asian", "Puerto Rican", "Other")
    ),
    malform = factor(
      malform,
      levels = c(0, 1),
      labels = c("absent", "present")
    )
  ) %>% 
  drop_na()
```

```{r}
## 1. Proposed model for birthweight ------------------------------------
model1 <-
  lm(
    bwt ~ gaweeks + blength + bhead +
      babysex + mrace +
      ppbmi + wtgain + smoken,
    data = birthweight
  )

summary(model1)

```
I selected predictors based on biological factors that are known to influence birthweight, such as gestational age, birth size measurements, and maternal characteristics. I also included smoking and demographic variables because they are commonly associated with differences in birthweight.


```{r}
tidy(model1)
glance(model1)

birthweight_resid <-
  birthweight %>%
  add_predictions(model1) %>%
  add_residuals(model1)

birthweight_resid %>%
  ggplot(aes(x = pred, y = resid)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed") +
  theme_minimal() +
  labs(
    x = "Fitted birthweight",
    y = "Residual",
    title = "Residuals vs fitted values for proposed birthweight model"
  )

```
The residuals are mostly centered around zero with no clear pattern, indicating the model fits reasonably well. There is some increase in spread at higher fitted birthweights and a few noticeable outliers, but the overall structure looks acceptable for a linear model.


Compare my model to two others:
```{r}
model2 <- lm(bwt ~ blength + gaweeks, data = birthweight)
model3 <- lm(bwt ~ bhead * blength * babysex, data = birthweight)
```

Cross-validated prediction error comparison
```{r}
set.seed(1)

cv_df <- 
  crossv_mc(birthweight, n = 100) %>%   
  mutate(
    train = map(train, as_tibble),
    test  = map(test,  as_tibble)
  )

cv_models <- 
  cv_df %>%
  mutate(
    mod1 = map(train, ~ lm(
      bwt ~ gaweeks + blength + bhead +
        babysex + mrace + ppbmi + wtgain + smoken,
      data = .x
    )),
    mod2 = map(train, ~ lm(bwt ~ blength + gaweeks, data = .x)),
    mod3 = map(train, ~ lm(bwt ~ bhead * blength * babysex, data = .x))
  ) %>%
    mutate(
    rmse1 = map2_dbl(mod1, test, ~ rmse(.x, .y)),
    rmse2 = map2_dbl(mod2, test, ~ rmse(.x, .y)),
    rmse3 = map2_dbl(mod3, test, ~ rmse(.x, .y))
  )

cv_long <- 
  cv_models %>%
  select(rmse1, rmse2, rmse3) %>%
  pivot_longer(
    cols = everything(),
    names_to = "model",
    values_to = "rmse"
  ) %>%
  mutate(
    model = recode(
      model,
      rmse1 = "Proposed model1",
      rmse2 = "Model2",
      rmse3 = "Model3"
    )
  )

cv_long %>%
  ggplot(aes(x = model, y = rmse)) +
  geom_violin() +
  theme_minimal() +
  labs(
    x = NULL,
    y = "RMSE (grams)",
    title = "Cross-validated prediction error for three birthweight models"
  )
```
The cross-validated RMSE values show clear differences in predictive performance among the three models. Model 2, which uses only birth length and gestational age, has noticeably higher RMSE values, indicating weaker predictive accuracy. Model 3 performs better, with lower RMSEs, but the proposed Model 1 achieves the lowest errors overall, suggesting it provides the best predictions among the three.
